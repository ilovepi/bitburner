/** @param {import("..").NS } ns */
function port_crack_count(ns) {
	var count = 0;
	const programs = ["BruteSSH.exe", "FTPCrack.exe", "relaySMTP.exe", "HTTPWorm.exe", "SQLInject.exe"];
	const home = "home";

	for (const program of programs) {
		if (ns.fileExists(program, home)) {
			//ns.tprintf("Found port: %s", program);
			count++;
		}
	}

	return count;
}



/** @param {import("..").NS } ns */
function breakPorts(ns, hostname) {
// try to open every port we can
	const home = "home"
	if (ns.fileExists("BruteSSH.exe", home))
		ns.brutessh(hostname);
	if (ns.fileExists("FTPCrack.exe", home))
		ns.ftpcrack(hostname);
	if (ns.fileExists("relaySMTP.exe", home))
		ns.relaysmtp(hostname);
	if (ns.fileExists("HTTPWorm.exe", home))
		ns.httpworm(hostname);
	if (ns.fileExists("SQLInject.exe", home))
		ns.sqlinject(hostname);
}

/** @param {import("..").NS } ns */
export async function main(ns) {
	var verbose = false;
	if (ns.args[0] == "-v")
		verbose = true;

	const exploit_script = "/scripts/early-game/hack_joes.js"
	var worklist = [];
	var visited = [];
	worklist.push(ns.getHostname())

	while (worklist.length != 0) {
		var target = worklist.pop(1);
		visited.push(target);
		var adjacent = ns.scan(target);
		for (const host of adjacent) {
			if (visited.includes(host)) {
				continue;
			} else {
				worklist.push(host);
			}
		}

		ns.tprintf("\tFound %s\n", target);

		const ports = ns.getServerNumPortsRequired(target);
		const can_crack = port_crack_count(ns);
		ns.tprintf("\t\tPorts: %d Crack: %d\n", ports, can_crack);

		if (ports <= can_crack) {
			breakPorts(ns, target);
			ns.nuke(target);
		}

		await ns.scp(exploit_script, target);
		var maxRam = ns.getServerMaxRam(target);
		var usedRam = ns.getServerUsedRam(target);
		var availRam = (maxRam - usedRam);
		var cost = ns.getScriptRam(exploit_script, target);
		var threads = Math.floor(availRam / cost);
		if (verbose) {
			ns.tprintf("\n\t\tMaxRam %d, UsedRam %d, available %d\n", maxRam, usedRam, availRam);
			ns.tprintf("\t\tcost: %d\n", cost);
			ns.tprintf("\t\tthreads: %d\n", threads);
		}
		if (threads) {
			ns.exec(exploit_script, target, threads, target, threads);
		}
	}
}